<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Animal Farm Historical Context Index</title>
    <!-- Load Tailwind CSS once here for the entire application -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Set default font to Inter, as required */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            margin: 0;
            padding: 0;
            min-height: 100vh; /* Ensure body takes full height */
        }
        /* Style for the navigation bar */
        .nav-bar {
            background-color: #333; /* Dark background */
            padding: 0.75rem 0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
            position: sticky;
            top: 0;
            z-index: 20;
        }
        /* Style for active link */
        .nav-link.active {
            background-color: #ef4444; /* Red for active state */
            color: white;
            font-weight: 700;
        }
        /* Style for the main content container */
        #chapter-content {
            padding: 1rem;
            max-width: 7xl;
            margin: auto;
            min-height: calc(100vh - 8rem); /* Ensure content area is tall enough */
        }
    </style>
</head>
<body>

    <!-- Main Title Header -->
    <header class="bg-gray-800 text-white p-4">
        <h1 class="text-xl md:text-2xl font-extrabold tracking-wider max-w-7xl mx-auto">
            Animal Farm Context: Chapter Navigator
        </h1>
    </header>

    <!-- Navigation Bar (Chapter Links) -->
    <nav class="nav-bar">
        <div id="nav-links-container" class="max-w-7xl mx-auto flex flex-wrap justify-center gap-2">
            <!-- Links are generated by the script below -->
        </div>
    </nav>

    <!-- Dynamic Content Container - Replaces the Iframe -->
    <div id="chapter-content" class="max-w-7xl mx-auto">
        <!-- Chapter content will be loaded here -->
        <div class="text-center text-gray-500 mt-12">Loading Chapter 1...</div>
    </div>

    <script>
        // Utility function to extract body content from a full HTML response
        // This is necessary because the fetched files were originally full pages
        function extractBodyContent(htmlString) {
            const bodyMatch = htmlString.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
            if (bodyMatch && bodyMatch[1]) {
                // If it's a full page, return content inside body tags
                return bodyMatch[1];
            }
            // If it's already a partial (which chapter1.html is now), just return the whole thing
            return htmlString;
        }

        async function loadChapter(chapterNum) {
            const contentDiv = document.getElementById('chapter-content');
            const linkContainers = document.querySelectorAll('.nav-link');
            const chapterPath = `pages/chapter${chapterNum}.html`;

            // Clear existing content and show a loader
            contentDiv.innerHTML = '<div class="text-center text-red-500 font-semibold mt-12">Loading Chapter ' + chapterNum + '...</div>';

            // Update active link styling
            linkContainers.forEach(l => {
                l.classList.remove('active');
                if (parseInt(l.dataset.chapter) === chapterNum) {
                    l.classList.add('active');
                }
            });

            try {
                const response = await fetch(chapterPath);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const fullHtml = await response.text();
                
                // Inject the content directly into the DIV
                // We use the full HTML fetch approach to support future chapters that might not be stripped down yet
                const contentToInject = extractBodyContent(fullHtml);
                contentDiv.innerHTML = contentToInject;
                
                // Re-execute scripts (important for the Genius embed script to run)
                const scripts = contentDiv.querySelectorAll('script');
                scripts.forEach(oldScript => {
                    const newScript = document.createElement('script');
                    Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                    newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                    // Replace the old script with the new one to force execution
                    oldScript.parentNode.replaceChild(newScript, oldScript);
                });


            } catch (error) {
                console.error("Failed to load chapter content:", error);
                contentDiv.innerHTML = `<div class="text-center text-red-600 p-8 bg-red-100 rounded-lg mt-12">
                    <h2 class="text-xl font-bold">Error Loading Chapter ${chapterNum}</h2>
                    <p class="mt-2">Could not find the file at <code>${chapterPath}</code>. Please ensure the file exists in the <code>pages/</code> directory and its name is correct (e.g., <code>chapter${chapterNum}.html</code>).</p>
                </div>`;
            }

            history.pushState(null, '', `#chapter${chapterNum}`);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const navBar = document.getElementById('nav-links-container');
            const totalChapters = 10;
            let initialChapter = 1;

            // Check URL hash on load
            const hash = window.location.hash;
            if (hash) {
                const match = hash.match(/#chapter(\d+)/);
                if (match) {
                    const chapterNum = parseInt(match[1]);
                    if (chapterNum >= 1 && chapterNum <= totalChapters) {
                        initialChapter = chapterNum;
                    }
                }
            }
            
            // Function to create chapter links
            for (let i = 1; i <= totalChapters; i++) {
                const link = document.createElement('a');
                link.href = `#chapter${i}`;
                link.textContent = `Chapter ${i}`;
                link.className = `nav-link px-3 py-1 rounded-full text-white text-sm hover:bg-red-600 transition duration-150 ease-in-out cursor-pointer`;
                link.dataset.chapter = i;

                link.addEventListener('click', (event) => {
                    event.preventDefault();
                    const chapterNum = parseInt(event.target.dataset.chapter);
                    loadChapter(chapterNum);
                });

                navBar.appendChild(link);
            }
            
            // Load the initial chapter
            loadChapter(initialChapter);
        });
    </script>

</body>
</html>
